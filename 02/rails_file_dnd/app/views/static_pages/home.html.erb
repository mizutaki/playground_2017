<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>ファイルのアップロード進捗</title>
    <div id="dropArea" style="background-color:blue; height:500px;width:500px;">
      ここにファイルをアップロードする
    </div>
    <progress id="progressBar" value="0" max="100"></progress>：
    <output id="progressBarParseint">0</output>%

    <div id="showArea"></div>
  </div>
  <script>
    (function () {
      var div = document.querySelector('#dropArea');
      div.addEventListener('dragover', function (e) {
        e.preventDefault()
        console.log("dragover");
      })
      div.addEventListener('drop', function (e) {
        e.preventDefault();
        console.log();
        fileUpload(e.dataTransfer);
      });
    })();

    function fileUpload(data) {
      for (var i = 0; i < data.files.length; i++) {
        var file = data.files[i];
        var fd = new FormData();
        fd.append("file", file, file.name);
        $.ajax('/static_pages/file_upload', {
          xhr: function () {
            XHR = $.ajaxSettings.xhr();
            if (XHR.upload) {
              XHR.upload.addEventListener('progress', function (e) {
                progre = parseInt(e.loaded / e.total * 10000) / 100;
                console.log(progre + "%");
                var progressBar = document.querySelector("#progressBar");
                progressBar.value = progre;
                var progressBarParseint = document.querySelector("#progressBarParseint");
                progressBarParseint.value = progre;
              }, false);
            }
            return XHR;
          },
          method: 'POST',
          contentType: false,
          processData: false,
          data: fd,
          dataType: 'text',
          success: function (m) {
            var img = document.createElement("img");
            img.src = m;
            var showArea = document.querySelector("#showArea");
            showArea.appendChild(img);
          }
        });
      }
    }
  </script>
</head>
</html>
